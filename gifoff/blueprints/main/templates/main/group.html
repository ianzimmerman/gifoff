{% extends "layout.html" %}
{% from "macros.html" import challenge_list %}
{% block title %}Groups{% endblock %}
{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" />
{% endblock %}
{% block breadcrumb %}{{ breadcrumbs(group=group) }}{% endblock %}
{% block content %}
    <div class="row">
        <div class="col-12">
            <h1 class="display-4" style="margin-bottom: 0">{{ group.name }}</h1>
            <p class="text-muted" style="margin-top: 0">owned by {{ group.owner.username }}</p>
            <blockquote class="blockquote">{{ group.description }}</blockquote>
            {% if current_user == group.owner %}
                <form id="authForm" class="form-group">
                <label for="authors">Manage Authors</label>
                <select name="authors" id="authors" class="form-control" multiple>
                    {% for p in group.players %}
                        <option value="{{p.id}}" {{ 'selected' if p in group.authors }}>{{ p.username }}</option>
                    {% endfor %}  
                </select>
                </form>
            {% endif %}
            <div class="d-flex justify-content-start">
                {% if current_user in group.authors and group.incomplete_count == 0 %}
                    <a href="{{ url_for('main.new_challenge', group_id=group) }}" class="m-1 btn btn-sm btn-primary">
                        <i class="fa fa-fw fa-plus-square"></i> New Challenge
                    </a>
                {% endif %}
                <a class="m-1 btn btn-sm btn-success" href="{{ url_for('main.join_group', name=group.name, pin=group.pin) }}">
                    <i class="fa fa-link"></i> Invite Link</a>
                <a href="{{ url_for('main.leave_group', group_id=group.id) }}" class="m-1 ml-auto btn btn-warning btn-sm align-self-start" onclick="return confirm('Really?')">
                        <i class="fa fa-sign-out"></i> Leave Group</a>
            </div>
            <hr>
        </div>
    </div>
    <div class="row">
        <div class="col-md">
            <h2 class="h4 text-muted">Active Challenge</h2>
            {{ challenge_list(challenges.active) }}
            <h2 class="h4 text-muted">Leaders</h2>
            <div class="list-group">
                {% set bg_color = ['lightyellow', 'whitesmoke', 'antiquewhite'] %}
                {% set color = ['gold', 'silver', 'sienna'] %}
                {% for p in group.leaders %}
                    <span class="list-group-item" style="background-color: {{ bg_color[loop.index-1] }}">
                        <i class="fa fa-trophy mr-3" style="color: {{ color[loop.index-1] }}; font-size: x-large"></i> 
                        <p class="lead mb-0">{{ p.username }}</p>
                        <span id="badges" class="ml-auto">
                            <span class="badge badge-success">Wins: {{ p.group_wins(group) }}</span>
                            <span class="badge badge-info">Avg. Score:  {{ p.group_score(group)/(p.group_entries(group) or 1) }}</span>
                        </span>
                    </span>
                {% endfor %}
            </div>
        </div>
        <div class="col-md">
            <h2 class="h4 text-muted">Completed Challenges</h2>
            {{ challenge_list(challenges.recent) }}
        </div>
    </div>
{% endblock %}
{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
            
        $authSelect = $("#authors");
        $authSelect.select2({
            placeholder: "Authors List"
        });
        
        $authSelect.on('change', function(){
            $authForm = $('#authForm').serialize();
            console.log($authForm);
            $.post(Flask.url_for('main.update_authors', { 'group_id':{{ group.id }} }), $authForm);
        });
        
    });
</script>
{% endblock %}
